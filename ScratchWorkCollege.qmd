---
title: "College Scratch"
author: "Corbin B; Matthew W"
format: pdf
editor: visual
---

```{r}

#library for data cleaning and graphs

library(tidyverse)

```

```{r}

# reading in data and creating factors
sal_df <- vroom::vroom("Salary.csv")

sal_df <- sal_df |>
  mutate(
    MajorCategory = factor(MajorCategory),
    Sex = factor(Sex)
  )

# creating a linear model. Salary predicted my Major, GPA and sex. No interaction
sal_lm<-lm(Salary~ .,sal_df)
#linear model that includes an interaction between GPA and MajorCategory
sal_lm_int_GPA_MAJ  <- lm(Salary ~ GPA * MajorCategory + Sex, data = sal_df)

head(sal_df)
```

## Impact of GPA - Corbin

### What impact, if any, does GPA have on salary? Do you think students should be hyper-anxious about grades?

```{r}


# 1) Pull GPA beta (estimate) and p-value from the summary object
smry <- summary(sal_lm)
coef_mat <- smry$coefficients

gpa_estimate <- coef_mat["GPA", "Estimate"]
gpa_pvalue   <- coef_mat["GPA", "Pr(>|t|)"]

# 2) Confidence interval (default 95%)
gpa_ci <- confint(sal_lm, "GPA", level = 0.95)

# Print nicely
cat("GPA beta (Estimate):", round(gpa_estimate, 4), "\n")
cat("GPA p-value        :", signif(gpa_pvalue, 4), "\n")
cat("GPA 95% CI         : [",
    round(gpa_ci[1], 4), ", ", round(gpa_ci[2], 4), "]\n", sep = "")


```

### Is the effect of GPA different for different majors (does GPA matter more for some majors than others)?. -Corbin

```{r}

# Recommended contrasts for Type III tests
options(contrasts = c("contr.sum", "contr.poly"))
car::Anova(sal_lm_int_GPA_MAJ, type = 3)
```

## Salaries Across Majors - Matthew

```{r}

# code to perform f-test between base lm, and an lm that doesn't include Major
print(anova(sal_lm, lm(Salary~ -MajorCategory,sal_df)))

# we see that major is significant, so now we view the summary of the model with major.
summary(sal_lm)

maj_df <- expand.grid(Sex = "F", GPA = 3.5, MajorCategory = unique(sal_df$MajorCategory))

maj_preds <- predict(sal_lm, new_data = as.data.frame(maj_df))

```

Yes, we see that "Engineering", "Computers and Mathematics", and "Physical Sciences" make the most.

```{r}

# make df for diff majors holding constant of female w/ 3.5 GPA
maj_df <- expand.grid(Sex = "F", GPA = 3.5, MajorCategory = unique(sal_df$MajorCategory))

# predict salaries for diff majors
maj_preds <- predict(sal_lm, newdata = maj_df)




```

```{r}

# Ensure you used the correct arg for base R lm
maj_preds <- predict(sal_lm, newdata = maj_df, se.fit = TRUE)

# Bind predictions back to maj_df
plot_df <- maj_df %>%
  mutate(
    .pred = maj_preds$fit,
  ) %>%
  # Order majors by predicted value for a nicer chart
  mutate(MajorCategory = reorder(MajorCategory, .pred))

library(scales)

ggplot(plot_df, aes(x = MajorCategory, y = .pred)) +
  geom_col(fill = "#4472C4") +
  coord_flip() +  # if you prefer horizontal bars (often easier to read)
  scale_y_continuous(
    breaks = scales::breaks_pretty(n = 5),      # more ticks
    minor_breaks = waiver(),                     # add minor gridlines
    labels = label_number(big.mark = ",")        # or label_dollar() if these are $ values
    # e.g., labels = label_dollar(accuracy = 1)
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor.y = element_line(color = "grey85"),  # emphasize minor gridlines
    panel.grid.major.y = element_line(color = "grey80")
  ) +
  labs(x = "Major category", y = "Predicted Salary", title = "Predicted Salary by Major")
```

## Salaries for Women and Men - Corbin

```{r}
sal_lm_sex_major <- lm(
  Salary ~ GPA + Sex * MajorCategory,
  data = sal_df
)

summary(sal_lm_sex_major)

```

Prediction

```{r}
library(dplyr)
library(tidyr)

# Ensure factors in newdata match the model's training data
# If your model used Sex = c("Female","Male"), adjust the levels/labels accordingly.
maj_df <- expand.grid(
  MajorCategory = levels(sal_df$MajorCategory),
  Sex           = c("F", "M"),
  GPA           = 3.5,
  KEEP.OUT.ATTRS = FALSE,
  stringsAsFactors = FALSE
) %>%
  arrange(MajorCategory, Sex) %>%                 # ensure (Major, then F, then M)
  mutate(
    MajorCategory = factor(MajorCategory, levels = levels(sal_df$MajorCategory)),
    Sex = factor(Sex, levels = levels(sal_df$Sex)) # IMPORTANT: match model levels
  )

# Predict for each row
maj_df$pred <- predict(sal_lm_sex_major, newdata = maj_df)

# Pivot to get columns pred_F and pred_M, then compute Male - Female
major_diffs <- maj_df %>%
  select(MajorCategory, Sex, pred) %>%
  tidyr::pivot_wider(names_from = Sex, values_from = pred, names_prefix = "pred_") %>%
  mutate(diff_M_minus_F = pred_M - pred_F) %>%
  arrange(MajorCategory)

major_diffs
```

```{r}
library(ggplot2)
library(dplyr)

# If you want to sort majors by the size of the difference:
major_diffs_plot <- major_diffs %>%
  mutate(
    # order by diff (largest positive at top after coord_flip)
    MajorCategory = reorder(MajorCategory, diff_M_minus_F),
    # color bars by direction of gap
    sign = ifelse(diff_M_minus_F >= 0, "Male > Female", "Female > Male")
  )

ggplot(major_diffs_plot, aes(x = MajorCategory, y = diff_M_minus_F, fill = sign)) +
  geom_col(width = 0.75) +
  geom_hline(yintercept = 0, color = "gray30") +
  coord_flip() +
  scale_fill_manual(values = c("Male > Female" = "#1f77b4", "Female > Male" = "#d62728")) +
  labs(
    title = "Predicted Salary Difference of Male vs Female",
    x = "Major Category",
    y = "Difference (USD, Male âˆ’ Female)",
    fill = "Direction"
  ) +
  scale_y_continuous(labels = scales::label_dollar()) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "top"
  )
```

## Other Factors - Matthew

```{r}

# linear model using all predictors and no interactions. As seen above, just defined again for clarity
sal_lm<-lm(Salary~ .,sal_df)

# linear model using all predictors and interactions found to be significant:
sal_interaction_lm <- lm(Salary ~ MajorCategory * Sex + MajorCategory * GPA, data = sal_df)


# function to perform k-fold cv for a single fold.
# take input of k, the kth fold
# calculates rmse for the models with and without interactions
# returns difference of rmse of the 2

cross_validate <- function(k){
  val_set <- sal_df |> filter(folds == k)
  train_set <- sal_df |> filter(folds != k)
  
  preds_1 <- predict.lm(lm(Salary ~ MajorCategory * Sex + MajorCategory * GPA, data = train_set),
            newdata = val_set)
  rmse_1 <- sqrt(mean((preds_1 - val_set[["Salary"]])^2))
  
  preds_2 <- predict.lm(lm(Salary ~ MajorCategory + Sex + GPA, data = train_set),
            newdata = val_set)
  rmse_2 <- sqrt(mean((preds_2 - val_set[["Salary"]])^2))
  
  rmse_1 - rmse_2
}

K <- 20

# randomly creates partitions for folds
folds <- rep(1:K, length = nrow(sal_df))|>
  sample()


rmse_results <- sapply(1:K, FUN = cross_validate)

# results of k-fold validation comparison
print(summary(rmse_results))
hist(rmse_results)



```

```{r}

# function similar to above
#instead of finding difference, just calclates rmse for 1 and returns it
cross_validate_one <- function(k){
  val_set <- sal_df |> filter(folds == k)
  train_set <- sal_df |> filter(folds != k)
  
  preds <- predict.lm(lm(Salary ~ Sex + MajorCategory + GPA, data = train_set),
            newdata = val_set)
  sqrt(mean((preds - val_set[["Salary"]])^2))
}

K <- 20

# see above cell
folds <- rep(1:K, length = nrow(sal_df))|>
  sample()


rmse_results <- sapply(1:K, FUN = cross_validate_one)

# statistics from k_folds
print(sd(sal_df[["Salary"]]))
print(mean(rmse_results))
print(summary(rmse_results))
```

## prediction for part 5

```{r}
set.seed(545)

# randomly selecting a person from the df
pick <- sample(1:length(sal_df$Salary),1)

# gets explanatory variables for that person
info <- as.data.frame(sal_df)[pick,2:4]

#makes prediction for salary
prediction <- predict(sal_lm, info)

#prints explanatory variables, and also difference between prediciton and actual salary.
print(info)
print(prediction - sal_df$Salary[pick])
```

## Model Validation

```{r}

# creates a plot of various lm assumptions
par(mfrow = c(2,2))
plot(sal_lm)

```
